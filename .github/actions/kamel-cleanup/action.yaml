# ---------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ---------------------------------------------------------------------------

name: kamel-cleanup
description: 'Cleans up the target cluster, removing any e2e test resources'

inputs:
  build-bundle-catalog-source:
    description: "Name of the catalog source for the build bundle image"
    required: true

runs:
  using: "composite"
  steps:
    - id: remove-installed-kamel
      name: Remove Installed Kamel
      shell: bash
      if: ${{ always() }}
      run: |
        set +e
        if command -v kamel &> /dev/null
        then
          kamel uninstall --olm=false --all
        fi

        # Ensure the CRDs are removed
        kubectl get crds | grep camel | awk '{print $1}' | xargs kubectl delete crd &> /dev/null
        set -e

    - id: remove-kamel-catalog-source
      name: Remove Catalog Source
      shell: bash
      if: ${{ always() }}
      run: |
        if [ -z "${{ inputs.build-bundle-catalog-source-name }}" ]; then
          # Catalog source never defined so nothing to do
          exit 0
        fi

        set +e
        CATALOG_NS=$(kubectl get catalogsource --all-namespaces | grep ${{ inputs.build-bundle-catalog-source-name }} | awk {'print $1'})
        for ns in ${CATALOG_NS}
        do
          kubectl delete CatalogSource ${{ inputs.build-bundle-catalog-source-name }} -n ${ns}
        done
        set -e
